Title: 学习写个代理工具-ORRO (2)
Date: 2015-01-23 21:00
Category: 项目
Tags: ORRO, 代理, Python
<!-- Slug:  -->
Author: Hanbin
<!-- Summary: 第一篇日志 -->
  
  
----
  
#####项目托管在https://github.com/lixingke3650/ORRO  
#####包含以下几篇文章  

>学习写个代理工具-ORRO (1)　　－　起因，构成  
>学习写个代理工具-ORRO (2)　　－　学习到的HTTP头知识  
>学习写个代理工具-ORRO (3)　　－　部署  


----  
  
HTTP头数量虽然不算多，但每一个都细细研究的话，  
一是没那么多时间，在一个也超出了个人的能力范围。  
下面记载的是实现ORRO的过程中遇到的HTTP头。  
开始吧，直接捡干货。  

#### 基本的注意项  
  
* HTTP头信息都以ASCII进行编码  
* 头/值对之间以<LF>或<CR><LF>分割  
* 支持长值换行，换行方法是在<LF>后至少有一个空格  
* 头部名字不区分大小写(请求方法例如GET，与值除外)  
* 头部名称与值以冒号(:)分隔，故名称或值中不能包含冒号  

#### Transfer-Encoding  
  
当服务器无法计算出返回Body信息的大小，或计算大小会消耗大量资源时，  
会将Transfer-Encoding都设为chunked来告知客户端，  
body信息大小未知，需根据body内容来确定。  

> HTTP/1.1 200 OK\r\n  
> Content-Type: text/html\r\n  
> Transfer-Encoding: chunked\r\n  
> \r\n  
> 6\r\n  
> hello\r\n  
> 5\r\n  
> world\r\n  
> 0\r\n
> \r\n  
  
对于结束的判断方法，简单来说就是一个块一个块读取，先获取块大小，  
然后读取相应尺寸的数据，再判断下一个块。  
如此反复直到遇到最后的0尺寸块，再出现两个回车换行(\r\n\r\n)，  
则body结束。  

v2.0版本中采取的方法是直接判断(0\r\n\r\n)，  
但数据块中也可能出现(0\r\n\r\n)的字符串，因此这种取巧的  
方法是错误的。  
  
#### Connection  
  
这个是通知对方是否保持当前socket连接的头信息，  
要明确的是是否保持socket连接，与HTTP的状态没有任何关系。  
保持socket的好处是免去每次http通信前建立连接的过程，  
快速的实现客户端与服务端的通信，缺点就是服务器同时  
保持大量的socket连接会影响效率。  
ORRO为了免去维护连接的处理，对每次返回给浏览器的数据中  
将此头修改为Connection: close.  
  
#### X-Cache　X-Cache-Lookup  

如果返回这个头说明在浏览器与web服务器之间还设立了缓存机制，  
这种缓存可能指squid之类的缓存服务器，也可能是指浏览器本身的缓存。  
X-Cache值为MISS时表明缓存过期，需要访问真正的web服务器。  
值为HIT是表明在缓存中发现需要浏览的内容，并由缓存直接返回数据给浏览器。  


#### Http头大小写敏感的问题  
  
通常的习惯是将Http头名称的首位字母设为大写，  
但我在测试的时候发现某个服务器将  
Content-Length 写成了 Content-length,导致ORRO不能正确识别，  
后来查了一些大小写敏感的问题，  
Http头名称对大小写是不敏感的(姑且认为是这样的吧)。  
是名称哦，值就不要动了。  
所以ORRO中需要修改头信息的时候会将所有头名称转换为小写，  
如果头信息不需要修改，则按原样转发(版本v2.0)。  


  
以上。  
20150123   
  
lily。         